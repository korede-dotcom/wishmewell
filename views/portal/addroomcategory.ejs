<%- include('partial/header', { title: 'Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>
<style>
	.spinner-border {
    width: 1rem;
    height: 1rem;
    border-width: .2em;
}

</style>
		<div class="page-wrapper">
			<div class="content container-fluid">
				<div class="page-header">
					<div class="row align-items-center">
					
						<div class="col">
							<h3 class="page-title mt-5">Add Room Category</h3>
							<a href="/portal/room-category">Go back</a>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-12">
						<form id="roomCategoryForm" enctype="multipart/form-data">
							<div class="row formtype">
								<!-- Category Name -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Category Name</label>
										<input name="category_name" type="text" class="form-control" id="category_name">
									</div>
								</div>
								<!-- Room Type -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Room Type</label>
										<select name="room_type" class="form-control" id="room_type">
											<option value="">Select</option>
											<option value="Single">Single</option>
											<option value="Double">Double</option>
										</select>
									</div>
								</div>
								<!-- AC -->
								<div class="col-md-4">
									<div class="form-group">
										<label>AC</label>
										<select name="has_ac" class="form-control" id="has_ac">
											<option value="">Select</option>
											<option value="YES">YES</option>
											<option value="NO">NO</option>
										</select>
									</div>
								</div>
								<!-- WIFI -->
								<div class="col-md-4">
									<div class="form-group">
										<label>WIFI</label>
										<select name="has_wifi" class="form-control" id="has_wifi">
											<option value="">Select</option>
											<option value="YES">YES</option>
											<option value="NO">NO</option>
										</select>
									</div>
								</div>
								<!-- Food -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Food</label>
										<select name="food" class="form-control" id="food">
											<option value="">Select</option>
											<option value="Free Breakfast">Free Breakfast</option>
											<option value="Free Lunch">Free Lunch</option>
											<option value="Free Dinner">Free Dinner</option>
											<option value="Free Breakfast & Dinner">Free Breakfast & Dinner</option>
											<option value="Free Welcome Drink">Free Welcome Drink</option>
											<option value="No Free Food">No Free Food</option>
										</select>
									</div>
								</div>
								<!-- Bed Count -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Bed Count</label>
										<select name="num_beds" class="form-control" id="num_beds">
											<option value="">Select</option>
											<option value="1">1</option>
											<option value="2">2</option>
											<option value="3">3</option>
											<option value="4">4</option>
											<option value="5">5</option>
											<option value="6">6</option>
										</select>
									</div>
								</div>
								<!-- Number of Guests -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Number of Guests</label>
										<select name="number_of_guests" class="form-control" id="number_of_guests">
											<option value="">Select</option>
											<option value="1">1</option>
											<option value="2">2</option>
											<option value="3">3</option>
											<option value="4">4</option>
											<option value="5">5</option>
											<option value="6">6</option>
										</select>
									</div>
								</div>
								<!-- Charges For Cancellation -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Charges For Cancellation</label>
										<select name="cancellations_fee" class="form-control" id="cancellations_fee">
											<option value="">Select</option>
											<option value="Free">Free</option>
											<option value="5% Before 24Hours">5% Before 24Hours</option>
											<option value="No Cancellation Allow">No Cancellation Allow</option>
										</select>
									</div>
								</div>
								<!-- Price -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Price</label>
										<input name="price" type="text" class="form-control" id="price">
									</div>
								</div>
								<!-- File Upload -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Image Upload</label>
										<div class="custom-file mb-3">
											<input name="pictures[]" type="file" class="custom-file-input" id="picture" accept="image/*" multiple>
											<label class="custom-file-label" for="picture">Choose images</label>
										</div>
									</div>
								
									<!-- Container to display selected images -->
									<div id="imagePreview" class="mt-3"></div>
								</div>
								<!-- Message -->
								<div class="col-md-4">
									<div class="form-group">
										<label>Message</label>
										<textarea  name="description" class="form-control" rows="5" id="text"></textarea>
									</div>
								</div>
							</div>
							<button type="submit" class="btn btn-primary buttonedit ml-2">
								<span class="button-text">Save</span>
								<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
							</button>
							<button type="button" class="btn btn-primary buttonedit">Cancel</button>
						</form>
						
					</div>
				</div>
				<!-- <button type="button" class="btn btn-primary buttonedit ml-2">Save</button>
				<button type="button" class="btn btn-primary buttonedit">Cancel</button> -->
			</div>
		</div>
	</div>
	<script src="assets/js/jquery-3.5.1.min.js"></script>
	<script src="assets/js/popper.min.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
	<script src="assets/js/moment.min.js"></script>
	<script src="assets/js/select2.min.js"></script>
	<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script src="assets/plugins/raphael/raphael.min.js"></script>
	<script src="assets/js/bootstrap-datetimepicker.min.js"></script>
	<script src="assets/js/script.js"></script>
	<script>
	$(function() {
		$('#datetimepicker3').datetimepicker({
			format: 'LT'
		});
	});
	</script>

<script>
	document.getElementById('roomCategoryForm').addEventListener('submit', async function(event) {
		event.preventDefault();
	
		// Get the form element
		const form = event.target;
	
		// Get the submit button and its elements
		const submitButton = form.querySelector('button[type="submit"]');
		const buttonText = submitButton.querySelector('.button-text');
		const spinner = submitButton.querySelector('.spinner-border');
	
		// Validate that all fields are not empty
		let valid = true;
		const inputs = form.querySelectorAll('input, select, textarea');
		const formData = {};
	
		inputs.forEach(input => {
			if (!input.value.trim() && input.type !== 'file') {
				valid = false;
				Toastify({
					text: `${input.name} is required!`,
					duration: 3000,
					close: true,
					gravity: "top",
					position: "center",
					stopOnFocus: true,
					style: {
						background: "red",
					}
				}).showToast();
			} else if (input.type !== 'file') {
				formData[input.name] = input.value; // Collect form field values
			}
		});
	
		if (!valid) {
			return; // Exit if validation fails
		}
	
		// Show spinner and disable submit button
		buttonText.classList.add('d-none');
		spinner.classList.remove('d-none');
		submitButton.disabled = true;
	
		// Get the files to be uploaded
		const files = form.querySelector('input[type="file"]').files;
		const uploadedImageUrls = [];
	
		// Upload each image to Cloudinary and collect the URLs
		for (const file of files) {
			const imageData = new FormData();
			imageData.append('file', file);
			imageData.append('upload_preset', 'wishmewell'); // Replace with your actual Cloudinary upload preset
			imageData.append('folder', 'wishmewell'); // Your folder name
	
			try {
				const cloudinaryResponse = await fetch(`https://api.cloudinary.com/v1_1/bada/image/upload`, {
					method: 'POST',
					body: imageData
				});
				const cloudinaryData = await cloudinaryResponse.json();
				uploadedImageUrls.push(cloudinaryData.secure_url); // Collect uploaded image URL
			} catch (error) {
				console.error('Error uploading to Cloudinary:', error);
				Toastify({
					text: 'An error occurred while uploading the image.',
					duration: 3000,
					close: true,
					gravity: "top",
					position: "center",
					stopOnFocus: true,
					style: {
						background: "red",
					}
				}).showToast();
				return; // Exit the function if upload fails
			}
		}
	
		// Add additional data
		formData.branch_id = 1;
		formData.picture = uploadedImageUrls; // Use the image URLs in the JSON
	
		try {
			// Send the form data (as JSON) using the fetch API
			const response = await fetch('/hotelmanager/create/category', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(formData), // Send JSON data
			});
	
			// Handle the response
			if (response.ok) {
				Toastify({
					text: "Category added successfully!",
					duration: 3000,
					close: true,
					gravity: "top",
					position: "center",
					stopOnFocus: true,
					style: {
						background: "green",
					}
				}).showToast();
				form.reset(); // Reset the form after successful submission
				document.getElementById('imagePreview').innerHTML = ''; // Clear image previews
			} else {
				const errorData = await response.json();
				Toastify({
					text: `Failed to add category: ${errorData.message}`,
					duration: 3000,
					close: true,
					gravity: "top",
					position: "center",
					stopOnFocus: true,
					style: {
						background: "red",
					}
				}).showToast();
			}
		} catch (error) {
			console.error('Error:', error);
			Toastify({
				text: 'An error occurred while submitting the form.',
				duration: 3000,
				close: true,
				gravity: "top",
				position: "center",
				stopOnFocus: true,
				style: {
					background: "red",
				}
			}).showToast();
		} finally {
			// Hide spinner and enable submit button
			spinner.classList.add('d-none');
			buttonText.classList.remove('d-none');
			submitButton.disabled = false;
		}
	});
	
	// Image preview functionality
	document.getElementById('picture').addEventListener('change', function(event) {
		const files = event.target.files;
		const imagePreview = document.getElementById('imagePreview');
	
		// Clear any previous images
		imagePreview.innerHTML = '';
	
		// Loop through selected files and create image previews
		Array.from(files).forEach(file => {
			const reader = new FileReader();
			reader.onload = function(e) {
				// Create an img element to display the image
				const img = document.createElement('img');
				img.src = e.target.result;
				img.alt = file.name;
				img.style.width = '100px'; // Adjust width as needed
				img.style.margin = '10px';
	
				// Append the img element to the preview container
				imagePreview.appendChild(img);
			};
			reader.readAsDataURL(file);
		});
	});
	</script>
	
	
</body>

</html>