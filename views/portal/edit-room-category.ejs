<%- include('partial/header', { title: 'Wishmewell Apartment', email: email, roleName: roleName }) %>
<%- include('partial/sidebar', { name: name }) %>
<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title mt-5">Edit Room Category: <%= categories.dataValues.category_name %></h3>
                    <a href="/portal/room-category">Go back</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <form id="roomCategoryForm" enctype="multipart/form-data">
                    <div class="row formtype">
                        <!-- Category Name -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Category Name</label>
                                <input name="category_name" type="text" class="form-control" id="category_name" value="<%= categories.dataValues.category_name %>">
                            </div>
                        </div>
                        <!-- Room Type -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Room Type</label>
                                <select name="room_type" class="form-control" id="room_type">
                                    <option value="">Select</option>
                                    <option value="Single" <%= categories.dataValues.room_type === 'Single' ? 'selected' : '' %>>Single</option>
                                    <option value="Double" <%= categories.dataValues.room_type === 'Double' ? 'selected' : '' %>>Double</option>
                                </select>
                            </div>
                        </div>
                        <!-- AC -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>AC</label>
                                <select name="has_ac" class="form-control" id="has_ac">
                                    <option value="">Select</option>
                                    <option value="YES" <%= categories.dataValues.has_ac === 'YES' ? 'selected' : '' %>>YES</option>
                                    <option value="NO" <%= categories.dataValues.has_ac === 'NO' ? 'selected' : '' %>>NO</option>
                                </select>
                            </div>
                        </div>
                        <!-- WIFI -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>WIFI</label>
                                <select name="has_wifi" class="form-control" id="has_wifi">
                                    <option value="">Select</option>
                                    <option value="YES" <%= categories.dataValues.has_wifi === 'YES' ? 'selected' : '' %>>YES</option>
                                    <option value="NO" <%= categories.dataValues.has_wifi === 'NO' ? 'selected' : '' %>>NO</option>
                                </select>
                            </div>
                        </div>
                        <!-- Food -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Food</label>
                                <select name="food" class="form-control" id="food">
                                    <option value="">Select</option>
                                    <option value="Free Breakfast" <%= categories.dataValues.food === 'Free Breakfast' ? 'selected' : '' %>>Free Breakfast</option>
                                    <option value="Free Lunch" <%= categories.dataValues.food === 'Free Lunch' ? 'selected' : '' %>>Free Lunch</option>
                                    <option value="Free Dinner" <%= categories.dataValues.food === 'Free Dinner' ? 'selected' : '' %>>Free Dinner</option>
                                    <option value="Free Breakfast & Dinner" <%= categories.dataValues.food === 'Free Breakfast & Dinner' ? 'selected' : '' %>>Free Breakfast & Dinner</option>
                                    <option value="No Free Food" <%= categories.dataValues.food === 'No Free Food' ? 'selected' : '' %>>No Free Food</option>
                                </select>
                            </div>
                        </div>
                        <!-- Bed Count -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Bed Count</label>
                                <select name="num_beds" class="form-control" id="num_beds">
                                    <option value="">Select</option>
                                    <option value="1" <%= categories.dataValues.num_beds === '1' ? 'selected' : '' %>>1</option>
                                    <option value="2" <%= categories.dataValues.num_beds === '2' ? 'selected' : '' %>>2</option>
                                    <option value="3" <%= categories.dataValues.num_beds === '3' ? 'selected' : '' %>>3</option>
                                    <option value="4" <%= categories.dataValues.num_beds === '4' ? 'selected' : '' %>>4</option>
                                    <option value="5" <%= categories.dataValues.num_beds === '5' ? 'selected' : '' %>>5</option>
                                    <option value="6" <%= categories.dataValues.num_beds === '6' ? 'selected' : '' %>>6</option>
                                </select>
                            </div>
                        </div>
                        <!-- Number of Guests -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Number of Guests</label>
                                <select name="number_of_guests" class="form-control" id="number_of_guests">
                                    <option value="">Select</option>
                                    <option value="1" <%= categories.dataValues.number_of_guests === '1' ? 'selected' : '' %>>1</option>
                                    <option value="2" <%= categories.dataValues.number_of_guests === '2' ? 'selected' : '' %>>2</option>
                                    <option value="3" <%= categories.dataValues.number_of_guests === '3' ? 'selected' : '' %>>3</option>
                                    <option value="4" <%= categories.dataValues.number_of_guests === '4' ? 'selected' : '' %>>4</option>
                                    <option value="5" <%= categories.dataValues.number_of_guests === '5' ? 'selected' : '' %>>5</option>
                                    <option value="6" <%= categories.dataValues.number_of_guests === '6' ? 'selected' : '' %>>6</option>
                                </select>
                            </div>
                        </div>
                        <!-- Charges For Cancellation -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Charges For Cancellation</label>
                                <select name="cancellations_fee" class="form-control" id="cancellations_fee">
                                    <option value="">Select</option>
                                    <option value="Free" <%= categories.dataValues.cancellations_fee === 'Free' ? 'selected' : '' %>>Free</option>
                                    <option value="5% Before 24Hours" <%= categories.dataValues.cancellations_fee === '5% Before 24Hours' ? 'selected' : '' %>>5% Before 24Hours</option>
                                    <option value="No Cancellation Allow" <%= categories.dataValues.cancellations_fee === 'No Cancellation Allow' ? 'selected' : '' %>>No Cancellation Allow</option>
                                </select>
                            </div>
                        </div>
                        <!-- Price -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Price</label>
                                <input name="price" type="text" class="form-control" id="price" value="<%= categories.dataValues.price %>">
                            </div>
                        </div>
                        <!-- File Upload -->
                        <!-- <div class="col-md-4">
                            <div class="form-group">
                                <label>Image Upload</label>
                                <div class="custom-file mb-3">
                                    <input name="pictures[]" type="file" class="custom-file-input" id="picture" accept="image/*" multiple>
                                    <label class="custom-file-label" for="picture">Choose images</label>
                                </div>
                            </div>

                        
                            <div id="imagePreview" class="mt-3"></div>
                        </div> -->

                        <!-- Message -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Message</label>
                                <textarea name="description" class="form-control" rows="5" id="text"><%= categories.dataValues.description %></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary buttonedit ml-2">Save</button>
                    <button type="button" class="btn btn-primary buttonedit">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/moment.min.js"></script>
<script src="assets/js/select2.min.js"></script>
<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="assets/plugins/raphael/raphael.min.js"></script>
<script src="assets/js/bootstrap-datetimepicker.min.js"></script>
<script src="assets/js/script.js"></script>

<script>
document.getElementById('roomCategoryForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // Prevent form from submitting

    const form = event.target;
    const formData = new FormData(form);

    // Track modified fields
    const modifiedFields = {};
    const originalValues = {
        category_name: '<%= categories.dataValues.category_name %>',
        room_type: '<%= categories.dataValues.room_type %>',
        has_ac: '<%= categories.dataValues.has_ac %>',
        has_wifi: '<%= categories.dataValues.has_wifi %>',
        food: '<%= categories.dataValues.food %>',
        num_beds: '<%= categories.dataValues.num_beds %>',
        number_of_guests: '<%= categories.dataValues.number_of_guests %>',
        cancellations_fee: '<%= categories.dataValues.cancellations_fee %>',
        price: parseFloat('<%= categories.dataValues.price %>'), // Ensure price is stored as a number
        description: '<%= categories.dataValues.description %>'
    };

    // Iterate through FormData and compare with original values
    formData.forEach((value, key) => {
        // Convert price to a number when it's a string
        if (key === "price") {
            value = parseFloat(value); // Convert the price to a number
        }

        // Only add the field to modifiedFields if it's different from the original and not empty
        if (value !== originalValues[key] && value !== "" && value !== null) {
            modifiedFields[key] = value;
        }
    });

    // Handle file inputs only if new files are uploaded
    // const picturesInput = document.getElementById('picture');
    // const pictures = picturesInput.files; // Get the file list directly
    // if (pictures.length > 0) {
    //     // Add pictures[] field only if new files are selected
    //     modifiedFields.pictures = [];
    //     for (let i = 0; i < pictures.length; i++) {
    //         modifiedFields.pictures.push(pictures[i]);
    //     }
    // }

    // If any fields are modified, send the request
    if (Object.keys(modifiedFields).length > 0) {
        try {
            const response = await fetch(`/portal/edit-room-category?id=${new URLSearchParams(window.location.search).get('id')}`, {
                method: 'POST',
                body: JSON.stringify(modifiedFields), // Send only modified fields
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                alert('Category updated successfully!');
            } else {
                alert('Error updating category: ' + result.message);
            }
        } catch (error) {
            alert('Failed to update category: ' + error.message);
        }
    } else {
        alert('No changes detected.');
    }
});



</script>

</body>

</html>
